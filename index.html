<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qiuzhaopeng.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Stay hungry, stay foolish">
<meta property="og:type" content="website">
<meta property="og:title" content="Zhaopeng&#39;s Homepage">
<meta property="og:url" content="http://qiuzhaopeng.github.io/index.html">
<meta property="og:site_name" content="Zhaopeng&#39;s Homepage">
<meta property="og:description" content="Stay hungry, stay foolish">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Zhaopeng QIU">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://qiuzhaopeng.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Zhaopeng's Homepage</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zhaopeng's Homepage</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">My tech notebook</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    

  <a href="https://github.com/QiuZhaopeng" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qiuzhaopeng.github.io/2022/01/09/Netlink-Communication-between-Kernel-and-User-space/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qiu.png">
      <meta itemprop="name" content="Zhaopeng QIU">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhaopeng's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/09/Netlink-Communication-between-Kernel-and-User-space/" class="post-title-link" itemprop="url">Netlink Communication between Kernel and User space</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-01-09 16:48:02 / Modified: 16:05:30" itemprop="dateCreated datePublished" datetime="2022-01-09T16:48:02+01:00">2022-01-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index"><span itemprop="name">IT</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Last year， I have used <strong>Netlink</strong> in my development work for collecting some events from kernel space. I present in this post some basic practice I have done when I learnt to program with <strong>Netlink</strong>.</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p><strong>Netlink</strong> is a Linux kernel interface used for** inter-process communication (IPC)** between both the kernel and userspace processes, and between different userspace processes, in a way similar to the <strong>Unix domain sockets</strong>. Similarly to the Unix domain sockets, and unlike <strong>INET</strong> sockets, Netlink communication cannot traverse host boundaries. <strong>Netlink</strong> provides a standard socket-based interface for userspace processes, and a kernel-side API for internal use by kernel modules. Originally, <strong>Netlink</strong> used the <strong>AF_NETLINK</strong> socket family. <strong>Netlink</strong> is designed to be a more flexible successor to <strong>ioctl</strong>; RFC 3549 describes the protocol in detail. </p>
<h2 id="My-practice"><a href="#My-practice" class="headerlink" title="My practice"></a>My practice</h2><h4 id="Kernel-module"><a href="#Kernel-module" class="headerlink" title="Kernel module"></a>Kernel module</h4><p>Below is the content of my source file “netlink_kernel.c” which yields a kernel module. There is macro <code>MY_NETLINK 30</code> which defines my customized netlink protocol. One can also choose available protocols such like <strong>NETLINK_ROUTE</strong> or <strong>NETLINK_INET_DIAG</strong>. All available protocols can be seen in <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.15.13/source/include/uapi/linux/netlink.h">this page</a>. Function <strong>netlink_kernel_create()</strong> creates a netlink socket for user space application to communicate with. More information about netlink programming can found <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/netlink.7.html">here</a>.</p>
<p>netlink_kernel.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/sock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/skbuff.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  refer to https://elixir.bootlin.com/linux/v5.15.13/source/include/linux/netlink.h</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_NETLINK 30  <span class="comment">// cannot be larger than 31, otherwise we shall get &quot;insmod: ERROR: could not insert module netlink_kernel.ko: No child processes&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">nl_sk</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">myNetLink_recv_msg</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlhead</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb_out</span>;</span></span><br><span class="line">	<span class="keyword">int</span> pid, res, msg_size;</span><br><span class="line">	<span class="keyword">char</span> *msg = <span class="string">&quot;Hello msg from kernel&quot;</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;Entering: %s\n&quot;</span>, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">	msg_size = <span class="built_in">strlen</span>(msg);</span><br><span class="line"></span><br><span class="line">	nlhead = (struct nlmsghdr*)skb-&gt;data;    <span class="comment">//nlhead message comes from skb&#x27;s data... (sk_buff: unsigned char *data)</span></span><br><span class="line"></span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;MyNetlink has received: %s\n&quot;</span>,(<span class="keyword">char</span>*)nlmsg_data(nlhead));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	pid = nlhead-&gt;nlmsg_pid; <span class="comment">// Sending process port ID, will send new message back to the &#x27;user space sender&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	skb_out = nlmsg_new(msg_size, <span class="number">0</span>);    <span class="comment">//nlmsg_new - Allocate a new netlink message: skb_out</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!skb_out)</span><br><span class="line">	&#123;</span><br><span class="line">		printk(KERN_ERR <span class="string">&quot;Failed to allocate new skb\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nlhead = nlmsg_put(skb_out, <span class="number">0</span>, <span class="number">0</span>, NLMSG_DONE, msg_size, <span class="number">0</span>);   <span class="comment">// Add a new netlink message to an skb</span></span><br><span class="line">	</span><br><span class="line">	NETLINK_CB(skb_out).dst_group = <span class="number">0</span>;                  </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">	<span class="built_in">strncpy</span>(nlmsg_data(nlhead), msg, msg_size); <span class="comment">//char *strncpy(char *dest, const char *src, size_t count)</span></span><br><span class="line"></span><br><span class="line">	res = nlmsg_unicast(nl_sk, skb_out, pid); </span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">		printk(KERN_INFO <span class="string">&quot;Error while sending back to user\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">myNetLink_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_kernel_cfg</span> <span class="title">cfg</span> =</span> &#123;</span><br><span class="line">		.input = myNetLink_recv_msg,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*netlink_kernel_create() returns a pointer, should be checked with == NULL */</span></span><br><span class="line">	nl_sk = netlink_kernel_create(&amp;init_net, MY_NETLINK, &amp;cfg);</span><br><span class="line">	printk(<span class="string">&quot;Entering: %s, protocol family = %d \n&quot;</span>,__FUNCTION__, MY_NETLINK);</span><br><span class="line">	<span class="keyword">if</span>(!nl_sk)</span><br><span class="line">	&#123;</span><br><span class="line">		printk(KERN_ALERT <span class="string">&quot;Error creating socket.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-10</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;MyNetLink Init OK!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">myNetLink_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;exiting myNetLink module\n&quot;</span>);</span><br><span class="line">	netlink_kernel_release(nl_sk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(myNetLink_init);</span><br><span class="line">module_exit(myNetLink_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="User-space-application"><a href="#User-space-application" class="headerlink" title="User space application"></a>User space application</h4><p>Below are the content of my file “netlink_client.c”. This program shall open a netlink socket with the same protocol and allow user to send/receive msg to/from kernel module in previous section.</p>
<p>netlink_client.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_USER 30 <span class="comment">// same customized protocol as in my kernel module</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_PAYLOAD 1024 <span class="comment">// maximum payload size</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">src_addr</span>, <span class="title">dest_addr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh2</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>, <span class="title">resp</span>;</span>  <span class="comment">// famous struct msghdr, it includes &quot;struct iovec *   msg_iov;&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>, <span class="title">iov2</span>;</span></span><br><span class="line"><span class="keyword">int</span> sock_fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> args, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//int socket(int domain, int type, int protocol);</span></span><br><span class="line">    sock_fd = socket(PF_NETLINK, SOCK_RAW, NETLINK_USER); <span class="comment">//NETLINK_KOBJECT_UEVENT	</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sock_fd &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;src_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(src_addr));</span><br><span class="line">    src_addr.nl_family = AF_NETLINK;</span><br><span class="line">    src_addr.nl_pid = getpid(); <span class="comment">/* self pid */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</span></span><br><span class="line">    <span class="keyword">if</span>(bind(sock_fd, (struct sockaddr*)&amp;src_addr, <span class="keyword">sizeof</span>(src_addr)))&#123;</span><br><span class="line">        perror(<span class="string">&quot;bind() error\n&quot;</span>);</span><br><span class="line">        close(sock_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;dest_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest_addr));</span><br><span class="line">    dest_addr.nl_family = AF_NETLINK;</span><br><span class="line">    dest_addr.nl_pid = <span class="number">0</span>;       <span class="comment">/* For Linux Kernel */</span></span><br><span class="line">    dest_addr.nl_groups = <span class="number">0</span>;    <span class="comment">/* unicast */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//nlh: contains &quot;Hello&quot; msg</span></span><br><span class="line">    nlh = (struct nlmsghdr *)<span class="built_in">malloc</span>(NLMSG_SPACE(MAX_PAYLOAD));</span><br><span class="line">    <span class="built_in">memset</span>(nlh, <span class="number">0</span>, NLMSG_SPACE(MAX_PAYLOAD));</span><br><span class="line">    nlh-&gt;nlmsg_len = NLMSG_SPACE(MAX_PAYLOAD);</span><br><span class="line">    nlh-&gt;nlmsg_pid = getpid();  <span class="comment">//self pid</span></span><br><span class="line">    nlh-&gt;nlmsg_flags = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//nlh2: contains received msg</span></span><br><span class="line">    nlh2 = (struct nlmsghdr *)<span class="built_in">malloc</span>(NLMSG_SPACE(MAX_PAYLOAD));</span><br><span class="line">    <span class="built_in">memset</span>(nlh2, <span class="number">0</span>, NLMSG_SPACE(MAX_PAYLOAD));</span><br><span class="line">    nlh2-&gt;nlmsg_len = NLMSG_SPACE(MAX_PAYLOAD);</span><br><span class="line">    nlh2-&gt;nlmsg_pid = getpid();  <span class="comment">//self pid</span></span><br><span class="line">    nlh2-&gt;nlmsg_flags = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(NLMSG_DATA(nlh), <span class="string">&quot;Hello this is a msg from userspace&quot;</span>);   <span class="comment">//put &quot;Hello&quot; msg into nlh</span></span><br><span class="line"></span><br><span class="line">    iov.iov_base = (<span class="keyword">void</span> *)nlh;         <span class="comment">//iov -&gt; nlh</span></span><br><span class="line">    iov.iov_len = nlh-&gt;nlmsg_len;</span><br><span class="line">    msg.msg_name = (<span class="keyword">void</span> *)&amp;dest_addr;  <span class="comment">//msg_name is Socket name: dest</span></span><br><span class="line">    msg.msg_namelen = <span class="keyword">sizeof</span>(dest_addr);</span><br><span class="line">    msg.msg_iov = &amp;iov;                 <span class="comment">//msg -&gt; iov</span></span><br><span class="line">    msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    iov2.iov_base = (<span class="keyword">void</span> *)nlh2;         <span class="comment">//iov -&gt; nlh2</span></span><br><span class="line">    iov2.iov_len = nlh2-&gt;nlmsg_len;</span><br><span class="line">    resp.msg_name = (<span class="keyword">void</span> *)&amp;dest_addr;  <span class="comment">//msg_name is Socket name: dest</span></span><br><span class="line">    resp.msg_namelen = <span class="keyword">sizeof</span>(dest_addr);</span><br><span class="line">    resp.msg_iov = &amp;iov2;                 <span class="comment">//resp -&gt; iov</span></span><br><span class="line">    resp.msg_iovlen = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sending message to kernel\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = sendmsg(sock_fd, &amp;msg, <span class="number">0</span>);   </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;send ret: %d\n&quot;</span>, ret); </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Waiting for message from kernel\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Read message from kernel */</span></span><br><span class="line">    recvmsg(sock_fd, &amp;resp, <span class="number">0</span>);  <span class="comment">//msg is also receiver for read</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Received message payload: %s\n&quot;</span>, (<span class="keyword">char</span> *) NLMSG_DATA(nlh2));  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> usermsg[MAX_PAYLOAD];</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Input your msg for sending to kernel: &quot;</span>);</span><br><span class="line">    	<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, usermsg);</span><br><span class="line">    </span><br><span class="line">    	<span class="built_in">strcpy</span>(NLMSG_DATA(nlh), usermsg);   <span class="comment">//put &quot;Hello&quot; msg into nlh</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;Sending message \&quot; %s \&quot; to kernel\n&quot;</span>, usermsg);</span><br><span class="line"></span><br><span class="line">    	ret = sendmsg(sock_fd, &amp;msg, <span class="number">0</span>);   </span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;send ret: %d\n&quot;</span>, ret); </span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Waiting for message from kernel\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Read message from kernel */</span></span><br><span class="line">	recvmsg(sock_fd, &amp;resp, <span class="number">0</span>);  <span class="comment">//msg is also receiver for read</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Received message payload: %s\n&quot;</span>, (<span class="keyword">char</span> *)NLMSG_DATA(nlh2));   </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">    close(sock_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>Makefile</p>
<p>Create a Makefile with the following content which will enable us to easily compile the source files.</p>
<p>Makefile</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">obj-m += netlink_kernel.o</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">generate the path</span></span><br><span class="line">CURRENT_PATH:=$(shell pwd)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">the current kernel version number</span></span><br><span class="line">LINUX_KERNEL:=$(shell uname -r)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">the absolute path</span></span><br><span class="line">LINUX_KERNEL_PATH:=/usr/src/linux-headers-$(LINUX_KERNEL)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">complie object</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   extension of <span class="string">&quot;make modules&quot;</span> cmd with -C option and <span class="string">&quot;M=dir&quot;</span> configuration</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   this cmd will switch working directory to the given path followed by the -C option</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   and will search specified <span class="built_in">source</span> files from the given path configured by <span class="string">&quot;M=&quot;</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash">   and compile them to generate ko files</span></span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">	@echo $(LINUX_KERNEL_PATH)</span><br><span class="line">	make -C $(LINUX_KERNEL_PATH) M=$(CURRENT_PATH) modules</span><br><span class="line"></span><br><span class="line">client:</span><br><span class="line">	gcc netlink_client.c -o netlink_client -g</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">clean</span></span><br><span class="line">clean:</span><br><span class="line">	make -C $(LINUX_KERNEL_PATH) M=$(CURRENT_PATH) clean</span><br><span class="line">	rm netlink_client</span><br></pre></td></tr></table></figure>

<h4 id="Test-the-communication"><a href="#Test-the-communication" class="headerlink" title="Test the communication"></a>Test the communication</h4><p>Make sure that files “netlink_kernel.c”, “netlink_client.c” and “Makefile” are in the same directory. In a Linux terminal window, <code>cd</code> into this directory and start the compilation:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make </span><br><span class="line">make client</span><br></pre></td></tr></table></figure>
<p>Normally kernel module file “netlink_kernel.ko” and user application file “netlink_client” will be generated.</p>
<p>Load the generated kernel module “netlink_kernel.ko” to linux kernel:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo insmod netlink_kernel.ko</span><br></pre></td></tr></table></figure>
<p>Execute in a new terminal the following cmd to monitor the kernel messages:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmesg -Hw</span><br></pre></td></tr></table></figure>
<p>Now start the user application to start the communication:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;netlink_client</span><br></pre></td></tr></table></figure>
<p>Below is the screenshot of my test:<br><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/swlujhqpxn2x9fz4gm0w.png" alt="Image description"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qiuzhaopeng.github.io/2021/12/31/About-Core-Dump-In-Linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qiu.png">
      <meta itemprop="name" content="Zhaopeng QIU">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhaopeng's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/31/About-Core-Dump-In-Linux/" class="post-title-link" itemprop="url">About Core Dump in Linux</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-12-31 10:21:54 / Modified: 10:33:49" itemprop="dateCreated datePublished" datetime="2021-12-31T10:21:54+01:00">2021-12-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="What-is-core-dump"><a href="#What-is-core-dump" class="headerlink" title="What is core dump"></a>What is core dump</h2><p>A core dump is a file of a computer’s documented memory of when a program or computer crashed. The file consists of the recorded status of the working memory at an explicit time, usually close to when the system crashed or when the program ended atypically. So a core dump file is very important for program developers since we often need it to locate and fix crash issues. </p>
<h2 id="How-to-activate-“core-dump”"><a href="#How-to-activate-“core-dump”" class="headerlink" title="How to activate “core dump”"></a>How to activate “core dump”</h2><ol>
<li><p>Firstly one can type <code>ulimit -c</code> in terminal console, if the output is 0，it means that the “core dump” is deactivated by default. In this case, Linux will not generate core dump file when a program crashes. </p>
</li>
<li><p>Then one can activate “core dump” by setting a non-zero size for generated core dump file by executing <code>ulimit -c [kbytes]</code>. For example:</p>
</li>
</ol>
<ul>
<li><code>ulimit -c 100</code>：set maximum size of core dump file as 100k</li>
<li><code>ulimit -c unlimited</code>: no size limit of core dump file</li>
</ul>
<h2 id="Configuration-of-core-dump"><a href="#Configuration-of-core-dump" class="headerlink" title="Configuration of core dump"></a>Configuration of core dump</h2><p>Once the core dump has been activated, we can get core dump file generated in local  repository. There is still one issue: the core dump file has always the same name as “core” thus it is always over-written if multiple program crashes occur. What if we want to add pid in generated file name, or if we want this file is generated in some other directory?</p>
<ol>
<li>core dump filename with process id</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/kernel/core_uses_pid</span><br></pre></td></tr></table></figure>
<p>Then process id will be attached in file name.</p>
<ol start="2">
<li>One can set the output path and coredump file name pattern by updating sysctl variable “kernel.core_pattern”  in file “/etc/sysctl.conf”</li>
</ol>
<p>Add the following phrase at the end of file sysctl.conf:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel.core_pattern = /var/core/core_%e_%p</span><br></pre></td></tr></table></figure>
<p>Save and exit. </p>
<p>Below are the available options in core_pattern setting:</p>
<ul>
<li><strong>%c</strong> maximum size of the generated file</li>
<li><strong>%e</strong> file name</li>
<li><strong>%g</strong> group ID of process</li>
<li><strong>%h</strong> host name</li>
<li><strong>%p</strong> process ID</li>
<li><strong>%s</strong> signal which triggered this coredump</li>
<li><strong>%t</strong> timestamp of this coredump (number of seconds since 1970-01-01)</li>
<li><strong>%u</strong> user ID of the dumped process</li>
</ul>
<p>Once a modification has been made, one can execute the following command to make it take effect:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl –p &#x2F;etc&#x2F;sysctl.conf</span><br></pre></td></tr></table></figure>
<p>Please note: once we have set /proc/sys/kernel/core_uses_pid as 1，the generated core dump file still has pid in its name even we do not set %p in _core_pattern_.</p>
<h2 id="Practice"><a href="#Practice" class="headerlink" title="Practice"></a>Practice</h2><p>In this section I present a small practice of coredump. Firstly I performed the following configurations (root privilege might be required) for coredump file generation:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ulimit -c 1000000</span><br><span class="line">ulimit -c</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/core_uses_pid</span><br><span class="line">echo &quot;/tmp/corefile/core-%e-%p-%t&quot; &gt; /proc/sys/kernel/core_pattern</span><br></pre></td></tr></table></figure>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fnxc6c72rrc0f13omqh6.png" alt="My settings"></p>
<p>Then let’s write some code to provoke a “Segmentation fault”.  I put the code lines below into file “testSegmtFault.c “.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> IDs[<span class="number">10</span>] = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>&#125;;</span><br><span class="line">  <span class="keyword">int</span> * id_ptr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;0x%lx: %d \n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)IDs, *IDs);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// correct logic</span></span><br><span class="line">  <span class="keyword">for</span>  (id_ptr=IDs; id_ptr&lt;=(&amp;IDs[<span class="number">9</span>]); id_ptr++)</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;0x%lx: %d \n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)id_ptr, *id_ptr);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bad logic</span></span><br><span class="line">  <span class="keyword">for</span>  (id_ptr=<span class="number">0</span>; id_ptr&lt;=(&amp;IDs[<span class="number">9</span>]); id_ptr++)</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;0x%lx: %d \n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)id_ptr, *id_ptr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Compile it then execute the generated executable file:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -g testSegmtFault.c -o seg</span><br><span class="line">./seg</span><br></pre></td></tr></table></figure>
<p>Execution output is as follows and there is a Segmentation Fault :D:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">qiu@qiu-ThinkCentre-E73:~&#x2F;workspace&#x2F;c_basics&#x2F;linux_flux$ .&#x2F;seg</span><br><span class="line">0x7ffe283297d0: 0 </span><br><span class="line">0x7ffe283297d0: 0 </span><br><span class="line">0x7ffe283297d4: 1 </span><br><span class="line">0x7ffe283297d8: 2 </span><br><span class="line">0x7ffe283297dc: 3 </span><br><span class="line">0x7ffe283297e0: 4 </span><br><span class="line">0x7ffe283297e4: 5 </span><br><span class="line">0x7ffe283297e8: 6 </span><br><span class="line">0x7ffe283297ec: 7 </span><br><span class="line">0x7ffe283297f0: 8 </span><br><span class="line">0x7ffe283297f4: 9 </span><br><span class="line">Segmentation fault</span><br></pre></td></tr></table></figure>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7rk5c32yodr67el5c9eg.png" alt="Crash occurrence:"></p>
<p>Now as expected, there is a coredump file named <em>“core-seg-20017-1639863524”</em> generated in <code>/tmp/corefile/</code></p>
<p>Now let’s use gdb to debug the crash with help of the executable file and the coredump file:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/corefile</span><br><span class="line">gdb ~/workspace/c_basics/linux_flux/seg core-seg-20017-1639863524</span><br></pre></td></tr></table></figure>
<p>We can see that gdb immediately shows the defective code line number:<br><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/s3ep8rnnblv409y5hfpb.png" alt="The debug output"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qiuzhaopeng.github.io/2021/02/26/Testing-Web-Apps-using-httpie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qiu.png">
      <meta itemprop="name" content="Zhaopeng QIU">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhaopeng's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/26/Testing-Web-Apps-using-httpie/" class="post-title-link" itemprop="url">Testing Web Apps using httpie</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-02-26 10:07:58 / Modified: 10:27:10" itemprop="dateCreated datePublished" datetime="2021-02-26T10:07:58+01:00">2021-02-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index"><span itemprop="name">IT</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Last year, I have managed the development of a WebApp for industrial supplychain sourcing in our start-up . It’s a typical B/S-architecture project whose server side was entirely developed by myself (Ubuntu running over AliCloud + Django + Neo4j + MongoDB + Docker + Tomcat + nginx + other dependences).</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/b8ng553af9rbp72kngw1.PNG" alt="Alt Text"></p>
<p>Below are some notes about a simple and powerful tool called <strong>httpie</strong> that I used for testing my APIs. These notes were taken in Chinese, however I add also simple translation in English in case someone happens to read this post and wants to understand it. </p>
<p>可以使用pip安装(installing using <code>pip</code> with a specified source)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade httpie -i http:&#x2F;&#x2F;pypi.douban.com&#x2F;simple --trusted-host pypi.douban.com</span><br></pre></td></tr></table></figure>
<p>测试get请求(testing a <code>GET</code> request)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http -v GET http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;suppliers_server&#x2F;get_user?username&#x3D;qiu</span><br></pre></td></tr></table></figure>
<p>测试POST带表单请求(testing a <code>POST</code> request)：<br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http --form POST http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;suppliers_server&#x2F;query_login username&#x3D;&quot;qiu&quot; password&#x3D;&quot;123456&quot;</span><br></pre></td></tr></table></figure><br>测试get请求带cookie(testing a <code>GET</code> request containing <code>cookie</code>)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http -v GET http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;corporadb&#x2F;login  Cookie:sessionid&#x3D;vc1d2m5kb1zul63l9g24qq5w58vfj35g</span><br></pre></td></tr></table></figure>
<p>将token包含在header中(testing a <code>GET</code> request containing <code>token</code>)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http -v GET http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;suppliers_server&#x2F;query_chain?product&#x3D;cd Cookie:sessionid&#x3D;y4nokqeymk54tdapicjjkmbve1qfuheo Authorization:eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6InFpdSJ9.qLDaly37vl77SxyHNPEqq6_HKzbSinmPcG9GvGQ-JdQ</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qiuzhaopeng.github.io/2021/02/23/Binary-search-algorithm-illustration%EF%BC%882%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qiu.png">
      <meta itemprop="name" content="Zhaopeng QIU">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhaopeng's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/23/Binary-search-algorithm-illustration%EF%BC%882%EF%BC%89/" class="post-title-link" itemprop="url">Binary search algorithm illustration（2）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-02-23 16:09:54" itemprop="dateCreated datePublished" datetime="2021-02-23T16:09:54+01:00">2021-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-24 00:39:01" itemprop="dateModified" datetime="2021-02-24T00:39:01+01:00">2021-02-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Following <a target="_blank" rel="noopener" href="https://dev.to/jemaloqiu/binary-search-algorithm-illustration-1eaj">previous post</a>, I would like to illustrate the solution of the following problem (figure below) using <strong>Binary search algorithm</strong>.<br><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ttgsxr0iewkbpazpmlf9.PNG" alt="Alt Text"><br>As shown in the figure above, we are given a sorted array <strong>v</strong> =  [2, 2, 2, 3, 3, 4, 5, 6, 6, 7] with repeated numbers, and we want to find the index of the first occurrence of target number 3. It’s easy for human to find that the answer should be 3 (we suppose index of the first element is 0). How for computers?</p>
<h2 id="Algorithm-illustration"><a href="#Algorithm-illustration" class="headerlink" title="Algorithm illustration"></a>Algorithm illustration</h2><p>As usual, we define three pointers: <code>l</code>, <code>r</code> and <code>mid</code>. They point respectively to the lower (left) bound index, the upper (right) bound index and the middle index of the searching range. We calculate <code>mid</code> as <code>mid = l + (r-l)/2</code>.</p>
<p>Initially, we search the entire array. So <code>l</code> = 0, <code>r</code> = 9 and <code>mid</code> = 4. Here is the first step:<br><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rutkm8mxo13137udql0q.png" alt="image"><br>Though <code>mid</code> points already to element whose value is equal to 3, we cannot stop searching since we are not sure if its the first occurrence in the array. So we continue to search by changing <code>r</code> to current value of <code>mid</code>. So we narrow down the searching range to the left half of the array:  <code>l</code> = 0, <code>r</code> = 4 and <code>mid</code> is updated to 2:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/scccki7gej68rjhmh0r9.PNG" alt="Alt Text"></p>
<p>Now the element pointed by <code>mid</code> is 2 and it is smaller than our target number 3. So we narrow down again the searching range to the right half of current searching range. Now  <code>l</code> = 3, <code>r</code> = 4 and <code>mid</code> is updated to 3:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tnbjhphhej20bbasgcwv.PNG" alt="Alt Text"></p>
<p>Now the element pointed by <code>mid</code> is 3 and it is equal to the target number 3. We now move <code>r</code> to current <code>mid</code>. So <code>l</code> = <code>r</code> =  <code>mid</code> = 3. Solution found!</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/asay6bqrh7pgbw869jpf.PNG" alt="Alt Text"></p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>I put all the steps of this example in one figure to demonstrate overview of the solution:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dwvrwrr9cce49i1y0t16.PNG" alt="Alt Text"></p>
<h2 id="C-Code"><a href="#C-Code" class="headerlink" title="C++ Code"></a>C++ Code</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* First occurency search </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foSearch</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; <span class="built_in">array</span>, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="built_in">array</span>.size()<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span> (l&lt;r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> mid = l + (r-l)/<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">array</span>[mid] &gt; target)</span><br><span class="line">        &#123;</span><br><span class="line">            r = mid<span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">array</span>[mid] == target)</span><br><span class="line">        &#123;</span><br><span class="line">            r = mid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            l = mid+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;l=&quot;</span> &lt;&lt; l &lt;&lt;  <span class="string">&quot;, r=&quot;</span> &lt;&lt; r &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">array</span>[l] == target)</span><br><span class="line">    &#123;</span><br><span class="line">        res = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vec &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">4</span>,<span class="number">9</span>, <span class="number">9</span>,<span class="number">12</span>,<span class="number">12</span>, <span class="number">12</span>,<span class="number">32</span>,<span class="number">43</span>, <span class="number">43</span>,<span class="number">43</span>, <span class="number">55</span>, <span class="number">55</span>, <span class="number">63</span>, <span class="number">77</span>, <span class="number">77</span>, <span class="number">98</span>, <span class="number">98</span>, <span class="number">98</span>, <span class="number">100</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> ans = foSearch(vec, <span class="number">43</span>);</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;ans is : &quot;</span> &lt;&lt; ans &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;value is : &quot;</span> &lt;&lt; vec[ans] &lt;&lt; <span class="built_in">endl</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qiuzhaopeng.github.io/2021/02/23/Binary-search-algorithm-illustration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qiu.png">
      <meta itemprop="name" content="Zhaopeng QIU">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhaopeng's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/23/Binary-search-algorithm-illustration/" class="post-title-link" itemprop="url">Binary search algorithm illustration</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-02-23 00:20:01 / Modified: 00:21:11" itemprop="dateCreated datePublished" datetime="2021-02-23T00:20:01+01:00">2021-02-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>“A picture is worth a thousand words”</p>
</blockquote>
<p>In order to explain to a friend how <strong>Binary search algorithm</strong> works, I drew several pictures to show solution of a simple problem using this algorithm. Here I would like to share it in this post. </p>
<p>As shown in the figure below, we are given a sorted array <strong>v</strong> = [1, 2, 3, 4, 5, 7, 9, 10, 12, 17], and we want to find index of the target number 9. One can see easily that the answer should be 6 (suppose index of the first element is 0).</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7ku0opzveuhu22j1jel8.PNG" alt="Alt Text"></p>
<h2 id="Binary-search-algorithm-illustration"><a href="#Binary-search-algorithm-illustration" class="headerlink" title="Binary search algorithm illustration"></a>Binary search algorithm illustration</h2><p>In <strong>Binary search algorithm</strong>, we define three pointers to elements: <code>l</code>, <code>r</code> and <code>mid</code>. They point respectively to the lower (left) bound index, the upper (right) bound index and the middle index of the range for searching. We calculate <code>mid</code> as <code>mid = l + (r-l)/2</code>.</p>
<p>Initially, we search the entire array. So <code>l</code> = 0, <code>r</code> = 9 and <code>mid</code> = 4. Here is the first step:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ch8p4qfojxbbtn1i1t6d.PNG" alt="Alt Text"></p>
<p>The element pointed by <code>mid</code> is 5 and it is smaller than our target number 9. So we narrow down the searching range to the right half of the array:  <code>l</code> = <code>mid</code>+1 = 5, <code>r</code> = 9 and <code>mid</code> is updated 7:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ex6o0oh656j6q450f2x7.PNG" alt="Alt Text"></p>
<p>Now the element pointed by <code>mid</code> is 10 and it is larger than our target number 9. So we narrow down again the searching range to its left half. </p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ci3m99kjafl12s5n7pg8.PNG" alt="Alt Text"></p>
<p>We repeat the same steps until the element pointed by <code>mid</code> is equal to the target number 9. See, we find out the index of number 9 in this array is 6.<br><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wfihxwdc78nlntqrxix7.PNG" alt="Alt Text"></p>
<h2 id="Binary-search-algorithm-code"><a href="#Binary-search-algorithm-code" class="headerlink" title="Binary search algorithm code"></a>Binary search algorithm code</h2><p>Below is the c++ code for this algorithm:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Binary search </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binSearch</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; <span class="built_in">array</span>, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="built_in">array</span>.size()<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span> (l&lt;=r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> mid = l + (r-l)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">array</span>[mid] == target)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">array</span>[mid] &gt; target)</span><br><span class="line">        &#123;</span><br><span class="line">            r = mid<span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            l = mid+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>I put all the steps of this example in one figure to demonstrate overview of the <strong>Binary search algorithm</strong>:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/gqm65k7cruocxc0kxcxu.png" alt="image"></p>
<h2 id="A-similar-problem"><a href="#A-similar-problem" class="headerlink" title="A similar problem"></a>A similar problem</h2><p>Here is a similar problem which can also be solved by varying a little the <strong>Binary search algorithm</strong>: in a sorted array with repeated elements, we would like to find index of the first occurrence of the target number. One can think of the solution. I will present the solution using figures in my next post. </p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/nyojhta92zf86jgqaci2.PNG" alt="Alt Text"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qiuzhaopeng.github.io/2021/02/18/Implementation-of-Tensorflow-Lite-model-on-Android/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qiu.png">
      <meta itemprop="name" content="Zhaopeng QIU">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhaopeng's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/18/Implementation-of-Tensorflow-Lite-model-on-Android/" class="post-title-link" itemprop="url">Implementation of Tensorflow Lite model on Android</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-02-18 23:38:24 / Modified: 23:41:12" itemprop="dateCreated datePublished" datetime="2021-02-18T23:38:24+01:00">2021-02-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Recently in some interview I have been asked about experience of implementing trained <strong>tensorflow</strong> models in android platform. I have tried one android project cloned from github which embedded a tflite model in it. However, I have not yet tried implementing my own model in an Android application. Thus I did such an exercise today and I successfully made my CNN model work on my Redmi Note 8 pro.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/am1dlr3zzlh786d15fn8.jpg" alt="Alt Text"></p>
<h2 id="CNN-model"><a href="#CNN-model" class="headerlink" title="CNN model"></a>CNN model</h2><p>Here is the code for training a <strong>CNN</strong> model with <code>mnist</code> dataset. This model then is converted as <code>tflite</code> model and shall be implemented in <strong>Android</strong> application for recognizing hand-write digits. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.environ[<span class="string">&#x27;TF_CPP_MIN_LOG_LEVEL&#x27;</span>] = <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow <span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span> tensorflow.keras <span class="keyword">import</span> datasets, layers, optimizers, Sequential, metrics,models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(x_train, y_train), (x_test, y_test) = tf.keras.datasets.mnist.load_data()</span><br><span class="line">print(x_train[<span class="number">0</span>,:,:])</span><br><span class="line"><span class="comment">## x_train.shape =&gt; (60000, 28, 28), y_train.shape =&gt; (60000,)</span></span><br><span class="line"><span class="comment">## x_test.shape =&gt; (10000, 28, 28), y_test.shape =&gt; (60000,)</span></span><br><span class="line">x_train = tf.expand_dims(x_train, -<span class="number">1</span>)</span><br><span class="line">x_test = tf.expand_dims(x_test, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">yt = tf.squeeze(y_train)  </span><br><span class="line"></span><br><span class="line">y_train = tf.squeeze(y_train)    </span><br><span class="line">y_test = tf.squeeze(y_test)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Dataset info: &quot;</span>, x_train.shape, y_train.shape, x_test.shape, y_test.shape)</span><br><span class="line"></span><br><span class="line">batch_size = <span class="number">128</span></span><br><span class="line"></span><br><span class="line">train_db = tf.data.Dataset.from_tensor_slices((x_train, y_train))</span><br><span class="line">train_db = train_db.shuffle(<span class="number">10000</span>).batch(batch_size)</span><br><span class="line"></span><br><span class="line">test_db = tf.data.Dataset.from_tensor_slices((x_test, y_test))</span><br><span class="line">test_db = test_db.batch(batch_size)</span><br><span class="line"></span><br><span class="line">train_iter = <span class="built_in">iter</span>(train_db)</span><br><span class="line">sample = <span class="built_in">next</span>(train_iter)</span><br><span class="line">print(sample[<span class="number">0</span>].shape, sample[<span class="number">1</span>].shape)  </span><br><span class="line"></span><br><span class="line"><span class="comment">##  build a standard cnn model</span></span><br><span class="line">model = models.Sequential()</span><br><span class="line">model.add(layers.Conv2D(<span class="number">32</span>, (<span class="number">3</span>, <span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>, input_shape=(<span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>)))</span><br><span class="line">model.add(layers.MaxPooling2D((<span class="number">2</span>, <span class="number">2</span>)))</span><br><span class="line">model.add(layers.Conv2D(<span class="number">64</span>, (<span class="number">3</span>, <span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>))</span><br><span class="line">model.add(layers.MaxPooling2D((<span class="number">2</span>, <span class="number">2</span>)))</span><br><span class="line">model.add(layers.Conv2D(<span class="number">64</span>, (<span class="number">3</span>, <span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>))</span><br><span class="line"></span><br><span class="line">model.add(layers.Flatten())</span><br><span class="line">model.add(layers.Dense(<span class="number">64</span>, activation=<span class="string">&#x27;relu&#x27;</span>))</span><br><span class="line">model.add(layers.Dense(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">model.summary()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>,</span><br><span class="line">              loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=<span class="literal">True</span>),</span><br><span class="line">             metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br><span class="line"></span><br><span class="line">train_history = model.fit(train_db, epochs=<span class="number">10</span>,          validation_data=test_db)</span><br><span class="line"></span><br><span class="line"><span class="comment">## once the model has been trained, convert it to tflite model</span></span><br><span class="line">converter = tf.lite.TFLiteConverter.from_keras_model(model)</span><br><span class="line">tflite_model = converter.convert()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;qiu_mnist_model.tflite&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(tflite_model)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Implementation-in-Android-app"><a href="#Implementation-in-Android-app" class="headerlink" title="Implementation in Android app"></a>Implementation in Android app</h2><p>I refereed to <a target="_blank" rel="noopener" href="https://margaretmz.medium.com/e2e-tfkeras-tflite-android-273acde6588">this post</a> for obtaining the original android project. I imported the kotlin version into my <strong>Android Studio</strong>. However, there were some bugs initially when I loaded my model into it. </p>
<p>My own model is located to <code>asset</code> repository:<br><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b7dylong7y5s6dtsnasn.PNG" alt="Alt Text"></p>
<p>The most important thing for this work is the following Gradle setting:<br><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/khmpkno356geyn128vmn.PNG" alt="Alt Text"></p>
<p>After about 15min of debugging and code modifications, I successfully made my model work. </p>
<p>Check out the video (there is still accuracy issue):</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/yIQ6RJx90yM" frameborder="0" loading="lazy" allowfullscreen></iframe></div>

<p>I will upload the android project src code to my github repo once I finish cleaning the code and improve the performance.</p>
<h6 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h6><ol>
<li><p><a target="_blank" rel="noopener" href="https://www.tensorflow.org/lite/performance/post_training_quantization">https://www.tensorflow.org/lite/performance/post_training_quantization</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://margaretmz.medium.com/e2e-tfkeras-tflite-android-273acde6588">https://margaretmz.medium.com/e2e-tfkeras-tflite-android-273acde6588</a></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qiuzhaopeng.github.io/2021/02/03/MQTT-communication-via-Cloud-Broker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qiu.png">
      <meta itemprop="name" content="Zhaopeng QIU">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhaopeng's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/03/MQTT-communication-via-Cloud-Broker/" class="post-title-link" itemprop="url">MQTT communication via Cloud Broker</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-02-03 11:30:58 / Modified: 12:55:43" itemprop="dateCreated datePublished" datetime="2021-02-03T11:30:58+01:00">2021-02-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>In my startup, we have worked on some AIoT (AI + IoT) projects and we’ve done some MVPs as demo to our client. In some certain project, we have used MQTT protocol for collecting sensors data and transporting them to other smart devices. So in this post, I would like to present a simple demo for building a MQTT communication via a broker on AWS cloud.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/0j7t523z4u1794795e8n.png" alt="Alt Text"></p>
<blockquote>
<p>MQTT (Message Queuing Telemetry Transport) is an open OASIS and ISO standard (ISO/IEC 20922) lightweight, publish-subscribe network protocol that transports messages between devices. The protocol usually runs over TCP/IP; however, any network protocol that provides ordered, lossless, bi-directional connections can support MQTT. It is designed for connections with remote locations where a “small code footprint” is required or the network bandwidth is limited.</p>
</blockquote>
<h2 id="Cloud-side"><a href="#Cloud-side" class="headerlink" title="Cloud side"></a>Cloud side</h2><p>On AWS server, I use docker to run an <strong>emqx</strong> service which play a role as “broker”. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --rm -ti --name emqx -p 18083:18083 -p 1883:1883 -e EMQX_ADMIN_PASSWORD=<span class="string">&quot;myPasswd&quot;</span> emqx/emqx:latest</span><br></pre></td></tr></table></figure>
<p>Output of my putty terminal:<br><img src="https://dev-to-uploads.s3.amazonaws.com/i/bvggl47m4yijn4ip8jow.png" alt="Alt Text"></p>
<p>When this service is running, one can access to its administration page by visiting <code>http://3.138.200.179:18083/#/</code>:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/oocjtky7e5sgkjcinidc.png" alt="Alt Text"></p>
<h2 id="Subscriber"><a href="#Subscriber" class="headerlink" title="Subscriber"></a>Subscriber</h2><p>I have a subcriber.py file which defines a <code>mqtt</code> client who connects to cloud broker with port 1883 and subscribes message named <code>&#39;qiu_data&#39;</code>. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paho.mqtt.client <span class="keyword">as</span> mqtt</span><br><span class="line"></span><br><span class="line"><span class="comment">## callback upon connection</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_connect</span>(<span class="params">client, userdata, flags, rc</span>):</span></span><br><span class="line">    print(<span class="string">&quot;Connected, result code: &quot;</span> + <span class="built_in">str</span>(rc))</span><br><span class="line"></span><br><span class="line"><span class="comment">## callback upon arrival of msg</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">client, userdata, msg</span>):</span></span><br><span class="line">    print(msg.topic + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(msg.payload))</span><br><span class="line"></span><br><span class="line">client = mqtt.Client()</span><br><span class="line">client.on_connect = on_connect</span><br><span class="line">client.on_message = on_message</span><br><span class="line"><span class="comment"># client.on_disconnect = on_disconnect</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## I have not yet bindded a domain name for my AWS ECS</span></span><br><span class="line">client.connect(<span class="string">&#x27;3.138.200.179&#x27;</span>, <span class="number">1883</span>, <span class="number">600</span>) <span class="comment"># 600ms: keepalive interval setting</span></span><br><span class="line">client.subscribe(<span class="string">&#x27;qiu_data&#x27;</span>, qos=<span class="number">0</span>)</span><br><span class="line">client.loop_forever() <span class="comment"># keep running</span></span><br></pre></td></tr></table></figure>
<h2 id="Publisher"><a href="#Publisher" class="headerlink" title="Publisher"></a>Publisher</h2><p>I have a publisher.py file which defines another <code>mqtt</code> client who connects to cloud broker with port 1883 and publish some data in  <code>&#39;qiu_data&#39;</code> messages. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paho.mqtt.client <span class="keyword">as</span> mqtt</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_connect</span>(<span class="params">client, userdata, flags, rc</span>):</span></span><br><span class="line">    print(<span class="string">&quot;Connected with result code: &quot;</span> + <span class="built_in">str</span>(rc))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">client, userdata, msg</span>):</span></span><br><span class="line">    print(msg.topic + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(msg.payload))</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;IoT&quot;</span>,</span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: time.time(),</span><br><span class="line">    <span class="string">&quot;msgId&quot;</span>:<span class="string">&quot;8ed7a307-0e82-9738-xxxx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;temp&quot;</span>:<span class="number">23.5</span>,</span><br><span class="line">        <span class="string">&quot;speed&quot;</span>:<span class="number">46.8</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">param = json.dumps(data)</span><br><span class="line"></span><br><span class="line">client = mqtt.Client()</span><br><span class="line">client.on_connect = on_connect</span><br><span class="line">client.on_message = on_message</span><br><span class="line">client.connect(<span class="string">&#x27;3.138.200.179&#x27;</span>, <span class="number">1883</span>, <span class="number">600</span>) <span class="comment"># 600ms for keepalive</span></span><br><span class="line">client.publish(<span class="string">&#x27;qiu_data&#x27;</span>, payload=<span class="string">&#x27;hello world&#x27;</span>, qos=<span class="number">0</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">client.publish(<span class="string">&quot;qiu_data&quot;</span>, payload=param, qos=<span class="number">0</span>) </span><br></pre></td></tr></table></figure>
<h2 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a>Execution</h2><p>In a terminal I type <code>python subcriber.py</code>, and in a second terminal I type <code>python publisher.py</code>. See the published topics have been received in the subscriber’s terminal:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/1hhk9ll9kb4n3eokhva9.PNG" alt="Alt Text"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qiuzhaopeng.github.io/2021/01/18/Breathing-Detection-Using-Computer-vision-with-webcam/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qiu.png">
      <meta itemprop="name" content="Zhaopeng QIU">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhaopeng's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/18/Breathing-Detection-Using-Computer-vision-with-webcam/" class="post-title-link" itemprop="url">Breathing Detection Using Computer vision with webcam</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-01-18 14:07:48 / Modified: 15:29:59" itemprop="dateCreated datePublished" datetime="2021-01-18T14:07:48+01:00">2021-01-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>When I worked on the development of a healthcare device for detecting baby Apnea (pause of breathing), I have spent some time on studying possible technological solutions. I have tried several different types of sensors including: RGB-camera, 3-axis accelerometer, heat camera, depth camera (kinect), etc. The rgb-camera-based solution is very interesting. Firstly because they are low-cost; moreover, it does not require mounting the sensor on baby’s body thus the comfort is guaranteed. That’s why I worked for about 3 weeks on this solution.</p>
<p>As experiments, I tried multiple possible algorithms including: feature points tracking, inter-frame difference checking, flux, and  color nuance variation tracking. </p>
<p>In this post, I want to present the latter one. This work is inspired by <a target="_blank" rel="noopener" href="http://people.csail.mit.edu/mrub/vidmag/">this study</a>. The basic idea is to track the color variation of an ROI on human face. The blood circulation and breathing will cause slight color variation of our skin. This change is so slight that our eyes can not perceive it at all. However, a normal webcam can identify color variation with a resolution as high as 2^16 grades. </p>
<h2 id="ROI-on-human-forehead"><a href="#ROI-on-human-forehead" class="headerlink" title="ROI on human forehead"></a>ROI on human forehead</h2><p>I have chosen a small rectangle area as ROI (region of interest) for tracking color variation. Below is the part of code for this purpose.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">x1 = <span class="number">0.4</span></span><br><span class="line">x2 = <span class="number">0.6</span></span><br><span class="line">y1 = <span class="number">0.1</span></span><br><span class="line">y2 = <span class="number">0.25</span></span><br><span class="line">face_cascade=cv2.CascadeClassifier(cv2.data.haarcascades + <span class="string">&quot;haarcascade_frontalface_default.xml&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFaceROI</span>(<span class="params">img</span>):</span></span><br><span class="line">    gray = cv2.cvtColor(img, cv2.COLOR_RGB2GRAY)</span><br><span class="line">    faces = face_cascade.detectMultiScale(gray, <span class="number">1.2</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(faces)&gt;<span class="number">0</span>:</span><br><span class="line">        img=cv2.rectangle(img, (faces[<span class="number">0</span>][<span class="number">0</span>] + <span class="built_in">int</span>(x1*faces[<span class="number">0</span>][<span class="number">2</span>]), faces[<span class="number">0</span>][<span class="number">1</span>]+ <span class="built_in">int</span>(y1*faces[<span class="number">0</span>][<span class="number">3</span>]) ), (faces[<span class="number">0</span>][<span class="number">0</span>]+ <span class="built_in">int</span>(x2*faces[<span class="number">0</span>][<span class="number">2</span>]), faces[<span class="number">0</span>][<span class="number">1</span>]+ <span class="built_in">int</span>(y2*faces[<span class="number">0</span>][<span class="number">3</span>]) ), (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [faces[<span class="number">0</span>][<span class="number">0</span>]+<span class="built_in">int</span>(x1*faces[<span class="number">0</span>][<span class="number">2</span>]),  faces[<span class="number">0</span>][<span class="number">1</span>]+ <span class="built_in">int</span>(y1*faces[<span class="number">0</span>][<span class="number">3</span>]),  faces[<span class="number">0</span>][<span class="number">0</span>]+ <span class="built_in">int</span>(x2*faces[<span class="number">0</span>][<span class="number">2</span>]), faces[<span class="number">0</span>][<span class="number">1</span>]+ <span class="built_in">int</span>(y2*faces[<span class="number">0</span>][<span class="number">3</span>])]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<h2 id="Color-Calculation"><a href="#Color-Calculation" class="headerlink" title="Color Calculation"></a>Color Calculation</h2><p>We simply calculate the average value of a given color channel (I used the green channel in my test) of all the pixels in the selected ROI.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getColorAverage</span>(<span class="params">frame, color_id</span>):</span></span><br><span class="line">    <span class="keyword">return</span> frame[:,:,color_id].<span class="built_in">sum</span>()*<span class="number">1.0</span> / (frame.shape[<span class="number">0</span>]*frame.shape[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<h2 id="Drawbacks"><a href="#Drawbacks" class="headerlink" title="Drawbacks"></a>Drawbacks</h2><p>Entire code has been uploaded to github repo below:<br><a target="_blank" rel="noopener" href="https://github.com/QiuZhaopeng/CV2_heartbeat_breathing_detection">https://github.com/QiuZhaopeng/CV2_heartbeat_breathing_detection</a></p>
<p>This solution suffers from limitations in multiple aspects, e.g. the lighting condition, human should stay still, the camera noisy level, etc. That’s why I did not choose this solution for our product (finally we chose the 6-axis sensor solution). </p>
<h2 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h2><p>Below is the snapshot of the execution of this program. As one can see, there are low-frequency wave shape mixed with high-frequency sawtooth (small peaks).<br><img src="https://dev-to-uploads.s3.amazonaws.com/i/jfa4iwr1jimxi67bjiro.png" alt="Alt Text"><br>I measured my pulses during execution of this program. It can be verified that each small peak corresponds to a pulse beat (heart beat). And the large peak-valley transition corresponds to breathing cycles. </p>
<p>Anyone interested in this small experiment are encouraged to try it and do some further work. Good luck.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qiuzhaopeng.github.io/2021/01/14/MongoDB-Compass-connection-issue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qiu.png">
      <meta itemprop="name" content="Zhaopeng QIU">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhaopeng's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/14/MongoDB-Compass-connection-issue/" class="post-title-link" itemprop="url">MongoDB Compass connection issue</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-01-14 12:27:03 / Modified: 12:33:28" itemprop="dateCreated datePublished" datetime="2021-01-14T12:27:03+01:00">2021-01-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index"><span itemprop="name">IT</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>I am working on migration of our <em>Data Warehouse</em> project from <em>Alibaba Cloud</em> to <em>Huawei Cloud</em> this week. All goes well, except one issue occurs when I tried to connect to <strong>MongoDB</strong> using <strong>MongoDB Compass Community</strong>. </p>
<p>As I have presented in my <a target="_blank" rel="noopener" href="https://dev.to/jemaloqiu/install-mongodb-with-docker-in-ubuntu-18-04-4pbi">previous post</a>, I have deployed <strong>MongoDB</strong> service using <strong>docker</strong> and I have successfully connected to my <strong>MongoDB</strong> database from <strong>IPython</strong> console. So I firstly tried again the visit from <strong>IPython</strong> today to make sure that the <strong>MongoDB</strong> service is still running on Huawei ECS. It IS still working well:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/inkrwaealqvcv183n10a.png" alt="Alt Text"></p>
<p>Then I open <strong>MongoDB Compass Community</strong> and fill the login information as below (our domain name has not yet been authorized so I have to use Ip address for <em>hostname</em>):<br><img src="https://dev-to-uploads.s3.amazonaws.com/i/e2uyrzwtepgxxkaao9q8.png" alt="Alt Text"><br>However, when I click “CONNECT” button, nothing happens.</p>
<p>After a close investigation, I found the reason. After I filled all the fields for connection, <strong>Compass</strong> yielded a connection URI string as below.<br><img src="https://dev-to-uploads.s3.amazonaws.com/i/iwfcg0mb6hebayyq9lhe.png" alt="Alt Text"></p>
<p>In fact, as explained in official manual of <strong>MongoDB</strong>, the standard URI syntax for connection is as:<br><code>mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]</code>.<br>Thus in my case, <strong>MongoDB Compass</strong> has strangely used <code>ip:port</code> as the Database name to visit. Since there is no database with such name, so it shall do nothing and stays in the connection interface.</p>
<p>Now I correct the URI string manually and fill my database name <em>suppliers</em> into this string as below:<br><img src="https://dev-to-uploads.s3.amazonaws.com/i/1wez341jzvar701lbflr.png" alt="Alt Text"></p>
<p>Once I click “CONNECT”, <strong>Compass</strong> jumps as expected to display interface of the queried database now:<br><img src="https://dev-to-uploads.s3.amazonaws.com/i/6s8udjmskichqb0ay5id.png" alt="Alt Text"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qiuzhaopeng.github.io/2021/01/12/Native-Mobile-Application-dev-using-HTML5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qiu.png">
      <meta itemprop="name" content="Zhaopeng QIU">
      <meta itemprop="description" content="Stay hungry, stay foolish">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhaopeng's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/12/Native-Mobile-Application-dev-using-HTML5/" class="post-title-link" itemprop="url">Native Mobile Application dev using HTML5</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-01-12 18:54:35" itemprop="dateCreated datePublished" datetime="2021-01-12T18:54:35+01:00">2021-01-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-13 10:14:58" itemprop="dateModified" datetime="2021-01-13T10:14:58+01:00">2021-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index"><span itemprop="name">IT</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>I started learning <strong>JavaScript</strong> since November 2018. Since then, I fell in love with this powerful language. In this post, I would like to share my experience of app dev using <strong>JavaScript</strong>  and to encourage you guys to develop apps using <strong>HTML5</strong> tech.</p>
<p>My first experience with <strong>JS</strong> started with <a target="_blank" rel="noopener" href="https://www.dcloud.io/mui.html"><code>MUI</code></a> by using which I aimed to develop an mobile application to measure human abdomen movements using smartphone’s accelerator sensor. <code>MUI</code> is a H5-based framework for developing “native” applications (can be called Chinese-version <code>Reaction Native</code>?). The <code>MUI</code> team has also developed <code>HTML5plus</code> sdk (Chinese-version <code>Cordova</code>) which grants applications the access to host device’s capabilities such as sensors, phone status, etc. With these tools, I have easily developed my application within two days. One month later, we have decided to develop an application for communicating with our smart wearable hardware via Bluetooth. Thus along with progress of hardware development, I have developed another application for testing communications with the hardware and for collecting test data. Several months later, this application becomes a very useful tool for our team, which is used to: flash the firmware, testing the stability of BLE connection, adjusting parameters for algorithm and embedded software, collecting debug logs, data collecting during nightly tests, ROB (robustness) issues investigation, etc.</p>
<p>For copyright reason, I cannot share the source code of this application. Below are screenshots of two non-secret parts of my code. The bluetooth dev manual is given <a target="_blank" rel="noopener" href="http://www.html5plus.org/doc/zh_cn/bluetooth.html">here</a>.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/rlz6vtuje0xeivoeiykx.PNG" alt="Alt Text"><br><img src="https://dev-to-uploads.s3.amazonaws.com/i/b3kgwudn816tvqoqo0co.PNG" alt="Alt Text"></p>
<p>This is a video showing how I did the test with my application and the wearable hardware prototype.</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/o4wFFWRzx88" frameborder="0" loading="lazy" allowfullscreen></iframe></div> 



<p>Another video of motion data collection on a premature baby using my app:</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/NwDZiueJlrw" frameborder="0" loading="lazy" allowfullscreen></iframe></div> 
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zhaopeng QIU"
      src="/images/qiu.png">
  <p class="site-author-name" itemprop="name">Zhaopeng QIU</p>
  <div class="site-description" itemprop="description">Stay hungry, stay foolish</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhaopeng QIU</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>


  















  

  

</body>
</html>
